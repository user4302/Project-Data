name: Update README and Portfolio

on:
  push:
    branches: [main]

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout projects-data
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with: { node-version: '20' }

      - name: Install dependencies
        run: npm install gray-matter  # If using frontmatter; add others as needed

      - name: Generate README content
        id: generate-readme
        run: node generate.js readme > readme-section.md

      - name: Update GitHub Profile README
        run: |
          if [ -z "${{ secrets.PAT }}" ]; then
            echo "Error: PAT secret is not set. Please create a Personal Access Token with 'repo' permissions and add it as PAT secret."
            exit 1
          fi
          
          # Check if profile repository exists
          if ! git ls-remote --exit-code https://user4302:${{ secrets.PAT }}@github.com/user4302/user4302.git > /dev/null 2>&1; then
            echo "Profile README repository (user4302/user4302.git) not found. Skipping profile README update."
            echo "To enable profile updates, create the repository at: https://github.com/user4302/user4302"
            echo "Add a README.md with markers: <!-- PROJECTS_START --> and <!-- PROJECTS_END -->"
            exit 0
          fi
          
          git clone https://user4302:${{ secrets.PAT }}@github.com/user4302/user4302.git profile-repo
          cd profile-repo
          # Assuming your README has a marker like <!-- PROJECTS_START -->...<!-- PROJECTS_END -->
          sed -i '/<!-- PROJECTS_START -->/,/<!-- PROJECTS_END -->/d' README.md
          echo "<!-- PROJECTS_START -->" >> README.md
          cat ../readme-section.md >> README.md
          echo "<!-- PROJECTS_END -->" >> README.md
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add README.md
          git commit -m "Auto-update projects in README" || echo "No changes"
          git push origin main

      - name: Generate Portfolio Data
        run: node generate.js portfolio  # Outputs projects.json

      - name: Update Portfolio Repo
        if: success()  # Assuming portfolio repo is separate
        run: |
          if [ -z "${{ secrets.GITLAB_TOKEN }}" ]; then
            echo "GitLab token not set. Skipping portfolio update."
            echo "To enable GitLab portfolio updates:"
            echo "1. Create a GitLab Personal Access Token with 'api' scope"
            echo "2. Add it as GITLAB_TOKEN secret to this repository"
            echo "3. Ensure the workflow has the correct GitLab repository URL"
            exit 0
          fi
          
          # Update GitLab repository (using GitLab token)
          git clone https://oauth2:${{ secrets.GITLAB_TOKEN }}@gitlab.com/user4302_Projects/coding/vue-js/angeloedz.git portfolio-repo
          cd portfolio-repo
          
          # Create src/data directory if it doesn't exist
          mkdir -p src/data
          
          cp ../projects.json src/data/projects.json  # Match your actual file structure
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add src/data/projects.json
          git commit -m "Auto-update projects data" || echo "No changes"
          git push origin main  # This triggers Netlify build if linked